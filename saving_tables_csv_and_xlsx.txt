" <itab> é nossa tabela main    
" validação modo de salvar CSV/XLSX

    IF p_csv IS NOT INITIAL.

      LOOP AT lt_fcat ASSIGNING FIELD-SYMBOL(<fs_cat>).
        lv_string = |{ lv_string }| & |{ <fs_cat>-fieldname }| & |{ ';' }|.
      ENDLOOP.
      APPEND lv_string TO lt_result.
      CLEAR lv_string.

      LOOP AT <itab> ASSIGNING FIELD-SYMBOL(<fs_itab>).
        LOOP AT lt_fcat ASSIGNING <fs_cat>.
          DATA(lv_field) = |<fs_itab>-| & |{ <fs_cat>-fieldname }|.
          ASSIGN (lv_field) TO FIELD-SYMBOL(<fs_field>).
          lv_string = |{ lv_string }| & |{ <fs_field> }| & |;|.
          REPLACE ALL OCCURRENCES OF '*' IN lv_string WITH ''.
          REPLACE ALL OCCURRENCES OF '#' IN lv_string WITH ''.
          REPLACE ALL OCCURRENCES OF '"' IN lv_string WITH ''.
        ENDLOOP.
        APPEND lv_string TO lt_result.
        CLEAR lv_string.
      ENDLOOP.

    ELSEIF p_xlsx IS NOT INITIAL.

      TRY.
          DATA: ir_data_ref TYPE REF TO data,
                lv_xresult  TYPE xstring.

          GET REFERENCE OF <itab> INTO ir_data_ref.

          DATA(lo_result1) =
            cl_salv_ex_util=>factory_result_data_table(
            r_data         = ir_data_ref
            t_fieldcatalog = lt_fcat ).

          cl_salv_bs_tt_util=>if_salv_bs_tt_util~transform(
            EXPORTING
              xml_type      = if_salv_bs_xml=>c_type_xlsx
              xml_version   = cl_salv_bs_a_xml_base=>get_version( )
              r_result_data = lo_result1
              xml_flavour   = if_salv_bs_c_tt=>c_tt_xml_flavour_export
              gui_type      = if_salv_bs_xml=>c_gui_type_gui
            IMPORTING
              xml           = lv_xresult ).
        CATCH cx_root.
          CLEAR lv_xresult.
      ENDTRY.
    ENDIF.